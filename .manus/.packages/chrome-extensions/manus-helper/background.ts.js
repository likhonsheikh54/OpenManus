var m=Object.defineProperty;var h=(n,e,t)=>e in n?m(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>(h(n,typeof e!="symbol"?e+"":e,t),t);const u={id:1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,responseHeaders:[{header:"content-disposition",operation:chrome.declarativeNetRequest.HeaderOperation.REMOVE},{header:"content-disposition",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"inline"}]},condition:{urlFilter:"*",resourceTypes:["main_frame","sub_frame"]}},p=[/google-analytics\.com/,/analytics\.google\.com/,/gtag/,/googletagmanager\.com/,/googleadservices\.com/,/googlesyndication\.com/,/clarity\.ms/,/firebaseio\.com/,/firebase.*\.com/,/sentry.*\.com/,/sentry-cdn\.com/,/hotjar\.com/,/doubleclick\.net/,/facebook\.com\/tr/,/linkedin\.com\/px/,/twitter\.com\/i\/jot/,/amplitude\.com/,/mixpanel\.com/,/segment\.com/,/segment\.io/];class g{constructor(){c(this,"activeRequests");c(this,"lastDomChange");c(this,"contentOnloadComplete");c(this,"thirdPartyScripts");this.reset()}reset(){this.activeRequests=new Map,this.lastDomChange=0,this.contentOnloadComplete=!1,this.thirdPartyScripts=new Set}isJavaScriptRequest(e){var t;return!!(e.type==="script"||(t=e.url.split("?")[0])!=null&&t.endsWith(".js"))}shouldTrackRequest(e){if(["image","font","media"].includes(e.type))return!1;if(this.isTrackingUrl(e.url))return console.log("is tracking url:",e.url),!1;if(this.contentOnloadComplete){if(this.isJavaScriptRequest(e))return console.log("is js:",e.url),this.thirdPartyScripts.add(e.url),!1;if(e.initiator){if(this.thirdPartyScripts.has(e.initiator))return!1;try{const r=new URL(e.initiator).hostname,i=new URL(e.url).hostname;if(r!==i)return!1}catch{return!0}}}return!0}isLoading(){const t=Date.now()-this.lastDomChange>1e3;if(!this.contentOnloadComplete)return console.log("content onload not complete"),!0;const r=this.activeRequests.size===0;return r||(console.log("has active requests:"),this.activeRequests.forEach(i=>{console.log("active request",i.url)})),!(t&&r)}contentOnloadFired(){this.contentOnloadComplete=!0}isTrackingUrl(e){return p.some(t=>t.test(e))}addRequest(e){this.shouldTrackRequest(e)&&this.activeRequests.set(e.requestId,e)}removeRequest(e){this.activeRequests.delete(e.requestId)}updateDomChange(e){this.lastDomChange=e}}class f{constructor(){c(this,"tabDetectors",new Map);this.init().catch(e=>{console.error("init error",e)})}async init(){await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[u.id],addRules:[u]});const e="reader-article-finder";(await chrome.scripting.getRegisteredContentScripts({ids:[e]})).length===0&&await chrome.scripting.registerContentScripts([{id:e,js:["assets/ReaderArticleFinder.js"],matches:["<all_urls>"],runAt:"document_start"}]),this.initLoadingDetector()}initLoadingDetector(){chrome.webNavigation.onBeforeNavigate.addListener(e=>{e.frameId===0&&this.getDetector(e.tabId).reset()}),chrome.webNavigation.onCompleted.addListener(e=>{e.frameId===0&&this.getDetector(e.tabId).contentOnloadFired()}),chrome.webRequest.onBeforeRequest.addListener(e=>{e.tabId>0&&this.getDetector(e.tabId).addRequest(e)},{urls:["<all_urls>"]},["requestBody"]),chrome.webRequest.onCompleted.addListener(e=>{e.tabId>0&&this.getDetector(e.tabId).removeRequest(e)},{urls:["<all_urls>"]}),chrome.webRequest.onErrorOccurred.addListener(e=>{e.tabId>0&&this.getDetector(e.tabId).removeRequest(e)},{urls:["<all_urls>"]}),chrome.runtime.onMessage.addListener((e,t,r)=>{var o;if(!((o=t.tab)!=null&&o.id))return;const i=this.getDetector(t.tab.id);if(e.type==="SCREENSHOT")return chrome.tabs.captureVisibleTab().then(a=>{r({dataUrl:a})}),!0;if(e.type==="FETCH_IMAGE")return this.handleFetchImage(e.url,r),!0;switch("type"in e?e.type:""){case"CHECK_LOADING_STATE":r({isLoading:i.isLoading()});break;case"DOM_CHANGED":"timestamp"in e&&e.timestamp&&i.updateDomChange(e.timestamp);break;case"CONTENT_ONLOAD":console.log("content onload fired",t.tab.url),i.contentOnloadFired();break;default:console.log("unknown message","type"in e?e.type:e)}}),chrome.tabs.onRemoved.addListener(e=>{this.tabDetectors.delete(e)})}getDetector(e){return this.tabDetectors.has(e)||this.tabDetectors.set(e,new g),this.tabDetectors.get(e)}handleFetchImage(e,t){let r="";fetch(e).then(i=>{const o=i.headers.get("content-type")||"";if(e.includes(".")){const s=e.split(".");r=s[s.length-1].toLowerCase().split(/[?#]/)[0]}const a=o.startsWith("image/")||["jpg","jpeg","png","gif","webp","svg","bmp"].includes(r),l=o==="application/octet-stream"||o==="binary/octet-stream"||o==="application/x-octet-stream";return i.blob().then(s=>{if(l&&a){let d="image/png";return r&&(d=this.fileExtensionToMime(r)),new Blob([s],{type:d})}return s})}).then(i=>{const o=new FileReader;o.onloadend=()=>{const a=o.result;if(a.startsWith("data:binary/octet-stream")||a.startsWith("data:application/octet-stream")||a.startsWith("data:application/x-octet-stream")){const l=this.fileExtensionToMime(r),s=a.replace(/^data:(binary|application)\/(x-)?octet-stream/,`data:${l}`);t({dataUrl:s})}else t({dataUrl:a})},o.onerror=()=>{t({dataUrl:"",error:"unable to fetch image"})},o.readAsDataURL(i)}).catch(i=>{console.error("\u83B7\u53D6\u56FE\u7247\u5931\u8D25:",i),t({dataUrl:"",error:i.message})})}fileExtensionToMime(e){return["jpg","jpeg"].includes(e)?"image/jpeg":e==="gif"?"image/gif":e==="webp"?"image/webp":e==="svg"?"image/svg+xml":e==="bmp"?"image/bmp":"image/png"}}new f;
